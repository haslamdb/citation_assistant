<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citation Assistant (Secure)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; font-size: 1.1em; }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        input:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { min-height: 200px; resize: vertical; }
        button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .hidden { display: none; }
        .error { color: #dc3545; margin-top: 10px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tab-content.active { display: block; }
        .results { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 6px; display: none; }
        .results.show { display: block; }
        .paper {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .paper-title { font-weight: 600; margin-bottom: 8px; }
        .paper-meta { color: #666; font-size: 0.9em; margin-bottom: 8px; }
        .paper-excerpt { color: #555; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .loading { text-align: center; padding: 40px; color: #667eea; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .user-info {
            float: right;
            color: white;
            opacity: 0.9;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            margin-left: 15px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-value { font-size: 2em; font-weight: 700; color: #667eea; }
        .stat-label { color: #666; font-size: 0.9em; margin-top: 5px; }
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .action-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: none;
            width: 100%;
        }
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }
        .action-card-icon {
            font-size: 3em;
            margin-bottom: 10px;
            display: block;
        }
        .action-card-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .action-card-desc {
            font-size: 0.85em;
            opacity: 0.9;
        }
        .stats-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card-compact {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        .stat-value-compact { font-size: 1.3em; font-weight: 600; color: #667eea; }
        .stat-label-compact { color: #888; font-size: 0.8em; margin-top: 3px; }
        .index-control {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .index-button {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            width: auto;
            transition: all 0.3s ease;
        }
        .index-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <h2 style="text-align: center; margin-bottom: 30px;">üîí Citation Assistant Login</h2>
        <form onsubmit="login(event)">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit">Login</button>
            <div id="login-error" class="error"></div>
        </form>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="main-app" class="hidden">
        <header>
            <div class="container">
                <div class="user-info">
                    Welcome, <span id="current-user"></span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
                <h1>üìö Citation Assistant</h1>
                <p class="subtitle">AI-powered citation suggestions (Secure)</p>
            </div>
        </header>

        <div class="container">
            <!-- Stats (de-emphasized) -->
            <div id="stats" class="stats-compact"></div>

            <!-- Index Control (next to stats) -->
            <div class="index-control">
                <h3 style="margin-top: 0; color: #0066cc; font-size: 1.1em;">üìä Active Optimizations</h3>
                <ul style="margin: 10px 0; padding-left: 20px; font-size: 0.9em; color: #555;">
                    <li><strong>Phase 1</strong>: Optimized search parameters (+25-35% quality)</li>
                    <li><strong>Phase 2</strong>: Semantic chunking (sentence-aware, 512 tokens)</li>
                    <li><strong>PubMedBERT</strong>: 768-dimensional biomedical embeddings</li>
                    <li><strong>Re-ranking</strong>: Cross-encoder available (+10-15% precision)</li>
                    <li><strong>Hybrid Search</strong>: Vector + BM25 available (+10-15% recall)</li>
                    <li><strong>Context</strong>: Using 10 papers (was 5) for summaries</li>
                </ul>
                <button class="index-button" onclick="runIndexing()">üîÑ Run Indexing</button>
                <div id="index-results" class="results"></div>
            </div>

            <!-- Action Cards (prominent) -->
            <div class="action-cards">
                <button class="action-card" onclick="switchTab('search')">
                    <span class="action-card-icon">üîç</span>
                    <div class="action-card-title">Search Papers</div>
                    <div class="action-card-desc">Find relevant papers in your library</div>
                </button>
                <button class="action-card" onclick="switchTab('summarize')">
                    <span class="action-card-icon">üìù</span>
                    <div class="action-card-title">Summarize Research</div>
                    <div class="action-card-desc">Generate research summaries</div>
                </button>
                <button class="action-card" onclick="switchTab('write')">
                    <span class="action-card-icon">‚úçÔ∏è</span>
                    <div class="action-card-title">Write Document</div>
                    <div class="action-card-desc">Create academic documents</div>
                </button>
                <button class="action-card" onclick="switchTab('suggest')">
                    <span class="action-card-icon">üí°</span>
                    <div class="action-card-title">Suggest Citations</div>
                    <div class="action-card-desc">Get citation recommendations</div>
                </button>
            </div>

            <!-- Search Tab -->
            <div id="search-tab" class="tab-content active">
                <h2>Search Your Library</h2>
                <form onsubmit="searchPapers(event)">
                    <div class="form-group">
                        <label for="search-query">Search Query</label>
                        <input type="text" id="search-query" placeholder="e.g., machine learning for genomics" required>
                    </div>
                    <div class="form-group">
                        <label for="search-n">Number of Results</label>
                        <input type="text" id="search-n" value="10">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="search-rerank" style="width: auto; margin-right: 8px;">
                            Enable Cross-Encoder Re-ranking (+10-15% precision, slightly slower)
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="search-hybrid" style="width: auto; margin-right: 8px;">
                            Enable Hybrid Search (Vector + BM25 keyword matching for +10-15% recall)
                        </label>
                    </div>
                    <div class="form-group" id="search-alpha-group" style="display: none;">
                        <label for="search-alpha">Hybrid Balance (0=pure BM25, 0.5=balanced, 1.0=pure vector)</label>
                        <input type="range" id="search-alpha" min="0" max="1" step="0.1" value="0.5">
                        <span id="search-alpha-value">0.5</span>
                    </div>
                    <button type="submit">Search</button>
                </form>
                <div id="search-results" class="results"></div>
            </div>

            <!-- Summarize Tab -->
            <div id="summarize-tab" class="tab-content">
                <h2>Summarize Research</h2>
                <form onsubmit="summarizeResearch(event)">
                    <div class="form-group">
                        <label for="summarize-query">Research Topic</label>
                        <input type="text" id="summarize-query" placeholder="e.g., microbiome analysis methods" required>
                    </div>
                    <div class="form-group">
                        <label for="summarize-n">Number of Papers</label>
                        <input type="text" id="summarize-n" value="10">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="summarize-rerank" style="width: auto; margin-right: 8px;">
                            Enable Cross-Encoder Re-ranking (better paper selection)
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="summarize-hybrid" style="width: auto; margin-right: 8px;">
                            Enable Hybrid Search (Vector + BM25 for better paper discovery)
                        </label>
                    </div>
                    <div class="form-group" id="summarize-alpha-group" style="display: none;">
                        <label for="summarize-alpha">Hybrid Balance (0=pure BM25, 0.5=balanced, 1.0=pure vector)</label>
                        <input type="range" id="summarize-alpha" min="0" max="1" step="0.1" value="0.5">
                        <span id="summarize-alpha-value">0.5</span>
                    </div>
                    <button type="submit">Generate Summary</button>
                </form>
                <div id="summarize-results" class="results"></div>
            </div>

            <!-- Write Document Tab -->
            <div id="write-tab" class="tab-content">
                <h2>Write Document</h2>
                <p style="margin-bottom: 20px; color: #666;">Generate a comprehensive academic document or grant proposal using only papers from your library.</p>
                <form onsubmit="writeDocument(event)">
                    <div class="form-group">
                        <label for="write-topic">Document Topic</label>
                        <input type="text" id="write-topic" placeholder="e.g., How was golgicide A discovered?" required>
                    </div>
                    <div class="form-group">
                        <label for="write-keywords">Keywords (optional - for aggressive boosting)</label>
                        <input type="text" id="write-keywords" placeholder="e.g., golgicide (comma-separated for multiple)">
                        <small style="color: #666; font-size: 0.9em;">Papers containing these exact terms will be strongly prioritized</small>
                    </div>
                    <div class="form-group">
                        <label for="write-style">Writing Style</label>
                        <select id="write-style" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="academic">Formal Academic (research article)</option>
                            <option value="grant">Grant Proposal (persuasive, impact-focused)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="write-length">Document Length</label>
                        <select id="write-length" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;">
                            <option value="short">Short (~500-750 words)</option>
                            <option value="medium">Medium (~1000-1500 words)</option>
                            <option value="long" selected>Long (~2000-3000 words)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="write-n-papers">Number of Source Papers</label>
                        <input type="number" id="write-n-papers" value="15" min="5" max="100">
                    </div>
                    <button type="submit">Generate Document</button>
                </form>
                <div id="write-results" class="results"></div>
            </div>

            <!-- Suggest Tab -->
            <div id="suggest-tab" class="tab-content">
                <h2>Get Citation Suggestions</h2>
                <form onsubmit="suggestCitations(event)">
                    <div class="form-group">
                        <label for="manuscript-text">Manuscript Text</label>
                        <textarea id="manuscript-text" placeholder="Paste your manuscript text here..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="suggest-n">Suggestions Per Statement</label>
                        <input type="text" id="suggest-n" value="3">
                    </div>
                    <button type="submit">Get Suggestions</button>
                </form>
                <div id="suggest-results" class="results"></div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = '';
        let authToken = localStorage.getItem('auth_token');
        let currentUser = localStorage.getItem('username');

        // Check if already logged in
        if (authToken) {
            showMainApp();
        }

        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const response = await fetch(`${API_BASE}/api/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Invalid credentials');
                }

                const data = await response.json();
                authToken = data.access_token;
                currentUser = username;

                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('username', username);

                showMainApp();
            } catch (error) {
                document.getElementById('login-error').textContent = 'Login failed: ' + error.message;
            }
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            authToken = null;
            currentUser = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('password').value = '';
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('current-user').textContent = currentUser;
            loadStats();
        }

        async function apiCall(url, options = {}) {
            if (!options.headers) options.headers = {};
            options.headers['Authorization'] = `Bearer ${authToken}`;

            const response = await fetch(url, options);

            if (response.status === 401) {
                logout();
                throw new Error('Session expired. Please login again.');
            }

            if (!response.ok) {
                let errorMsg = 'Request failed';
                try {
                    const error = await response.json();
                    errorMsg = error.detail || errorMsg;
                } catch (e) {
                    // If response is not JSON (e.g., HTML error page), read as text
                    const errorText = await response.text();
                    console.error('Non-JSON error response:', errorText);
                    errorMsg = `Server error (${response.status}): ${errorText.substring(0, 200)}`;
                }
                throw new Error(errorMsg);
            }

            return response.json();
        }

        async function loadStats() {
            try {
                const stats = await apiCall(`${API_BASE}/api/stats`);
                const opt = stats.optimizations || {};
                const optimizationIcon = opt.phase2_semantic_chunking ? 'üöÄ' : '‚úì';
                const optimizationText = opt.phase2_semantic_chunking ? 'Phase 2' : 'Phase 1';

                document.getElementById('stats').innerHTML = `
                    <div class="stat-card-compact">
                        <div class="stat-value-compact">${stats.total_indexed_files.toLocaleString()}</div>
                        <div class="stat-label-compact">Indexed Files</div>
                    </div>
                    <div class="stat-card-compact">
                        <div class="stat-value-compact">${stats.collection_size.toLocaleString()}</div>
                        <div class="stat-label-compact">Text Chunks</div>
                    </div>
                    <div class="stat-card-compact">
                        <div class="stat-value-compact">${optimizationIcon} ${optimizationText}</div>
                        <div class="stat-label-compact">Optimizations</div>
                    </div>
                    <div class="stat-card-compact">
                        <div class="stat-value-compact">üîí Secure</div>
                        <div class="stat-label-compact">Status</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

            // Show the selected tab
            const tabElement = document.getElementById(`${tabName}-tab`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
        }

        function showLoading(elementId) {
            const el = document.getElementById(elementId);
            el.innerHTML = '<div class="loading"><div class="spinner"></div><p>Processing...</p></div>';
            el.classList.add('show');
        }

        async function searchPapers(event) {
            event.preventDefault();
            showLoading('search-results');

            try {
                const useReranking = document.getElementById('search-rerank').checked;
                const useHybrid = document.getElementById('search-hybrid').checked;
                const hybridAlpha = parseFloat(document.getElementById('search-alpha').value);

                const data = await apiCall(`${API_BASE}/api/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: document.getElementById('search-query').value,
                        n_results: parseInt(document.getElementById('search-n').value),
                        use_reranking: useReranking,
                        use_hybrid: useHybrid,
                        hybrid_alpha: hybridAlpha
                    })
                });

                const resultsEl = document.getElementById('search-results');
                if (data.papers.length === 0) {
                    resultsEl.innerHTML = '<p>No papers found.</p>';
                    return;
                }

                let html = `<h3>Found ${data.papers.length} papers</h3>`;
                if (data.hybrid_used) {
                    html += `<p style="font-size:0.9em;color:#10b981;margin-bottom:10px;">‚úì Hybrid search (Vector + BM25) applied with Œ±=${data.hybrid_alpha}</p>`;
                }
                if (data.reranking_used) {
                    html += `<p style="font-size:0.9em;color:#667eea;margin-bottom:10px;">‚úì Cross-encoder re-ranking applied for improved precision</p>`;
                }
                html += `<p style="font-size:0.9em;color:#666;margin-bottom:15px;">Similarity scores typically range 1-5% (higher is better). Scores use normalized L2 distance.</p>`;
                data.papers.forEach((paper, i) => {
                    const scoreDisplay = paper.rerank_score !== undefined
                        ? `Re-rank Score: ${paper.rerank_score.toFixed(2)} | Original Similarity: ${(paper.similarity * 100).toFixed(1)}%`
                        : `Similarity: ${(paper.similarity * 100).toFixed(1)}%`;
                    html += `
                        <div class="paper">
                            <div class="paper-title">${i + 1}. ${paper.filename}</div>
                            <div class="paper-meta">${scoreDisplay}</div>
                            <div class="paper-excerpt">${paper.text.substring(0, 300)}...</div>
                        </div>
                    `;
                });
                resultsEl.innerHTML = html;
            } catch (error) {
                document.getElementById('search-results').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function summarizeResearch(event) {
            event.preventDefault();
            showLoading('summarize-results');

            try {
                const useReranking = document.getElementById('summarize-rerank').checked;
                const useHybrid = document.getElementById('summarize-hybrid').checked;
                const hybridAlpha = parseFloat(document.getElementById('summarize-alpha').value);

                const data = await apiCall(`${API_BASE}/api/summarize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: document.getElementById('summarize-query').value,
                        n_papers: parseInt(document.getElementById('summarize-n').value),
                        use_reranking: useReranking,
                        use_hybrid: useHybrid,
                        hybrid_alpha: hybridAlpha
                    })
                });

                let html = `<h3>Summary: ${data.query}</h3>`;
                if (useHybrid) {
                    html += `<p style="font-size:0.9em;color:#10b981;margin-bottom:5px;">‚úì Papers found using hybrid search (Œ±=${hybridAlpha})</p>`;
                }
                if (data.reranking_used) {
                    html += `<p style="font-size:0.9em;color:#667eea;margin-bottom:10px;">‚úì Papers selected using cross-encoder re-ranking (${data.n_papers_used} papers)</p>`;
                } else {
                    html += `<p style="font-size:0.9em;color:#666;margin-bottom:10px;">Based on ${data.n_papers_used} papers</p>`;
                }
                html += `<div class="paper-excerpt" style="white-space: pre-wrap;">${data.summary}</div>`;

                document.getElementById('summarize-results').innerHTML = html;
            } catch (error) {
                document.getElementById('summarize-results').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function writeDocument(event) {
            event.preventDefault();
            showLoading('write-results');

            try {
                const data = await apiCall(`${API_BASE}/api/write`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: document.getElementById('write-topic').value,
                        keywords: document.getElementById('write-keywords').value,
                        style: document.getElementById('write-style').value,
                        length: document.getElementById('write-length').value,
                        n_papers: parseInt(document.getElementById('write-n-papers').value)
                    })
                });

                const resultsEl = document.getElementById('write-results');
                const lengthMap = { short: '500-750', medium: '1000-1500', long: '2000-3000' };
                const styleMap = { academic: 'Formal Academic', grant: 'Grant Proposal' };

                let html = `
                    <h3>${data.topic}</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        Style: ${styleMap[data.style]} |
                        Length: ${lengthMap[data.length]} words
                    </p>
                    <div style="background: white; padding: 20px; border-radius: 6px; line-height: 1.8; white-space: pre-wrap; font-family: Georgia, serif;">
                        ${data.document}
                    </div>
                    <button onclick="copyToClipboard()" style="margin-top: 20px; width: auto; padding: 10px 30px;">
                        Copy to Clipboard
                    </button>
                `;
                resultsEl.innerHTML = html;
                resultsEl.classList.add('show');

                // Store document for copying
                window.lastDocument = data.document;
            } catch (error) {
                document.getElementById('write-results').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        function copyToClipboard() {
            if (window.lastDocument) {
                navigator.clipboard.writeText(window.lastDocument).then(() => {
                    alert('Document copied to clipboard!');
                }).catch(err => {
                    alert('Failed to copy: ' + err);
                });
            }
        }

        async function suggestCitations(event) {
            event.preventDefault();
            showLoading('suggest-results');

            try {
                const formData = new FormData();
                formData.append('text', document.getElementById('manuscript-text').value);
                formData.append('n_suggestions', document.getElementById('suggest-n').value);

                const data = await apiCall(`${API_BASE}/api/suggest/text`, {
                    method: 'POST',
                    body: formData
                });

                const resultsEl = document.getElementById('suggest-results');
                if (data.suggestions.length === 0) {
                    resultsEl.innerHTML = '<p>No suggestions generated.</p>';
                    return;
                }

                let html = `<h3>Found ${data.suggestions.length} statements</h3>`;
                data.suggestions.forEach((s, i) => {
                    html += `<div class="paper"><h4>Statement ${i + 1}</h4><p style="font-style:italic;">"${s.statement}"</p>`;
                    s.suggested_papers.forEach((p, j) => {
                        html += `<div style="margin-top:10px;padding:10px;background:#f8f9fa;border-radius:4px;">
                            <strong>[${j + 1}] ${p.filename}</strong> (${(p.similarity * 100).toFixed(1)}%)<br>
                            ${p.text.substring(0, 150)}...
                        </div>`;
                    });
                    html += '</div>';
                });
                resultsEl.innerHTML = html;
            } catch (error) {
                document.getElementById('suggest-results').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function runIndexing() {
            showLoading('index-results');

            try {
                const data = await apiCall(`${API_BASE}/api/index`, { method: 'POST' });
                const failedMsg = data.results.failed_files > 0
                    ? `<p style="color: #e67e22; margin-top: 10px;">‚ö† Failed/skipped files: ${data.results.failed_files} (corrupted or incomplete PDFs)</p>`
                    : '';
                document.getElementById('index-results').innerHTML = `
                    <div style="margin-top: 15px; padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px;">
                        <h4 style="margin-top: 0; color: #155724;">‚úì Indexing Complete</h4>
                        <p style="margin: 5px 0; font-size: 0.9em;"><strong>New files processed:</strong> ${data.results.new_files}</p>
                        <p style="margin: 5px 0; font-size: 0.9em;"><strong>Total chunks indexed:</strong> ${data.results.total_chunks}</p>
                        <p style="margin: 5px 0; font-size: 0.9em;"><strong>Collection size:</strong> ${data.results.collection_size.toLocaleString()}</p>
                        ${failedMsg}
                    </div>
                `;
                loadStats();
            } catch (error) {
                document.getElementById('index-results').innerHTML = `<div style="margin-top: 15px; padding: 15px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 4px;"><p class="error">Error: ${error.message}</p></div>`;
            }
        }

        // Event listeners for hybrid search controls
        document.addEventListener('DOMContentLoaded', function() {
            // Search tab hybrid controls
            const searchHybridCheckbox = document.getElementById('search-hybrid');
            const searchAlphaGroup = document.getElementById('search-alpha-group');
            const searchAlphaSlider = document.getElementById('search-alpha');
            const searchAlphaValue = document.getElementById('search-alpha-value');

            searchHybridCheckbox.addEventListener('change', function() {
                searchAlphaGroup.style.display = this.checked ? 'block' : 'none';
            });

            searchAlphaSlider.addEventListener('input', function() {
                searchAlphaValue.textContent = this.value;
            });

            // Summarize tab hybrid controls
            const summarizeHybridCheckbox = document.getElementById('summarize-hybrid');
            const summarizeAlphaGroup = document.getElementById('summarize-alpha-group');
            const summarizeAlphaSlider = document.getElementById('summarize-alpha');
            const summarizeAlphaValue = document.getElementById('summarize-alpha-value');

            summarizeHybridCheckbox.addEventListener('change', function() {
                summarizeAlphaGroup.style.display = this.checked ? 'block' : 'none';
            });

            summarizeAlphaSlider.addEventListener('input', function() {
                summarizeAlphaValue.textContent = this.value;
            });
        });
    </script>
</body>
</html>
